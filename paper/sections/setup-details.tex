\section{Detailed Setup Protocol} \label{sec:setup-details}
\Cref{alg:username-attestation} and \Cref{alg:credentials-issuance} detail the protocols composing the setup phase presented in \Cref{sec:setup}.
\alberto{Add rate-limiting tokens in blue}

\begin{figure*}
    \pseudocodeblock{
    \textbf{KYC Provider} \<\< \textbf{User $A$}  \\
    [0.1 \baselineskip][\hline] \<\< \\
    \text{secret key: $\sk_I$} \<\< \\
    \text{public key: $(\pk_{I,1}, \pk_{I,2}) \in (\GG_1, \GG_2)$} \<\< \\
    %
    \< \sendmessageleft*{\text{Prove ownership of username } n_A} \< \\
    \text{$\sigma_{I,1} \gets H_1(n_A)^{\sk_I} \in \GG_1$} \\
    \text{$\sigma_{I,2} \gets H_2(n_A)^{\sk_I} \in \GG_2$} \\
    \< \sendmessageright*{\sigma_{I,1}, \sigma_{I,2}} \< \\
    \<\< \text{verify:} \\
    \<\< \text{$\qquad e(\sigma_{I,1}, g_2) = e(H_1(n_A), \pk_{I,2})$} \\
    \<\< \text{$\qquad e(g_1, \sigma_{I,2}) = e(\pk_{I,1}, H_2(n_A))$} \\
    }
    \caption{Username attestation protocol (step~\one of \Cref{fig:arke-overview}). User $A$ proves ownership of its username $n_A$ through traditional means and receives a signature over it.}
    \Description{}
    \label{alg:username-attestation}
\end{figure*}

\begin{figure*}
    \pseudocodeblock{
    \textbf{User $A$} \<\< \textbf{Credentials Authority $i$}  \\
    [0.1 \baselineskip][\hline] \<\< \\
    \text{attestation: $(\sigma_{I,1}, \sigma_{I,2}) \in (\GG_1, \GG_2)$} \<\< \text{secret key: $\sk_{S,i}$} \\
    \<\< \text{public key: $(\pk_{S,1,i}, \pk_{S,2,i}) \in (\GG_1, \GG_2)$}\\
    %
    \text{$r \pick \ZZ_q$} \\
    \text{$\widehat{n_{A,1}} \gets H_1(n_A)^{r} \in \GG_1$} \\
    \text{$\widehat{n_{A,2}} \gets H_2(n_A)^{r} \in \GG_2$} \\
    \< \sendmessageright*{\widehat{n_{A,1}}, \widehat{n_{A,2}}, \sigma_{I,1}^r, \sigma_{I,2}^r} \< \\
    \<\< \text{verify:} \\
    \<\< \text{$\qquad e(\sigma_{I,1}^r, g_2) = e(\widehat{n_{A,1}}, \pk_{I,2})$} \\
    \<\< \text{$\qquad e(g_1, \sigma_{I,2}^r) = e(\pk_{I,1}, \widehat{n_{A,2}})$} \\
    \<\< \text{$\widehat{\sigma_{S, 1, i}} \gets (\widehat{n_{A,1}})^{\sk_{S,i}} \in \GG_1$} \\
    \<\< \text{$\widehat{\sigma_{S, 2, i}} \gets (\widehat{n_{A,2}})^{\sk_{S,i}} \in \GG_2$} \\
    \< \sendmessageleft*{\widehat{\sigma_{S, 1, i}}, \widehat{\sigma_{S, 2, i}}} \< \\
    \text{verify:} \<\< \\
    \text{$\qquad e(\sigma_{S, 1, i}, g_2) = e(\widehat{n_{A,1}}, \pk_{S,2,i})$} \<\< \\
    \text{$\qquad e(g_1, \sigma_{S, 2, i}) = e(\pk_{S,2,i}, \widehat{n_{A,2}})$} \<\< \\
    \text{$H_1(n_A)^{\sk_{S,i}} \gets \sigma_{S, 1}^{(-r)} \in \GG_1$} \<\< \\
    \text{$H_2(n_A)^{\sk_{S,i}} \gets \sigma_{S, 2}^{(-r)} \in \GG_2$} \<\< \\
    }
    \caption{Credentials issuance protocol (step~\two of \Cref{fig:arke-overview}). User $A$ shows the KYC Provider's attestation over its username $n_A$ (without revealing it) to the authorities to receive a long-term credential over it.}
    \label{alg:credentials-issuance}
    \Description{}
\end{figure*}
